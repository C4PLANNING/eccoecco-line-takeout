<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <!-- Bootstrap -->
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>


    <link rel="stylesheet" href="/style.css">
    <title>申込情報を入力</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>

        // const firebaseConfig = {
        //     apiKey: process.env.REACT_APP_FIREBASE_API_KEY,
        //     authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
        //     projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
        //     storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,
        //     messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,
        //     appId: process.env.REACT_APP_FIREBASE_APP_ID,
        //     measurementId: process.env.REACT_APP_FIREBASE_MEASUREMENT_ID,
        // };
        const firebaseConfig = {
            apiKey: "AIzaSyBdsDtEvTLH8JKcfRpuPR15eGtoYGiD2qE",
            authDomain: "eccoecco-line-takeout.firebaseapp.com",
            projectId: "eccoecco-line-takeout",
            storageBucket: "eccoecco-line-takeout.appspot.com",
            messagingSenderId: "283788282761",
            appId: "1:283788282761:web:5a9b7389a4162ad0976f58",
            measurementId: "G-70RJ90MCQP",
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.firestore();

        window.onload = async function (e) {
            const result = await addDate();
            let myLiffId = "";
            // APIからLIFF IDのJSONを取得する
            fetch('./info')
                .then((response) => response.json())
                .then(function (jsonResponse) {
                    myLiffId = jsonResponse.id;
                    initializeLiff(myLiffId);
                })

            // sendにclickイベントを追加
            document.getElementById('send').addEventListener('click', async function () {
                var name = $("input[name='name']").val();
                var number = $("input[name='number']").val();
                var date = $("select[name='date']").val();
                var time = $("select[name='time']").val();
                const regex = /^0\d{9,10}$/;
                // LIFFアプリをLINE内ブラウザで動作させているかどうかを取得します。
                if (!liff.isInClient()) {
                    window.alert('LIFFは現在外部ブラウザで開いているため、このボタンは使用できません。');
                } else if (!name || !number || !date || !time || time === "時間を選択") {
                    window.alert('全てに入力をお願いします。');
                } else if (!regex.test(number.replace(/[━.*‐.*―.*－.*\-.*ー.*\-]/gi, ''))) {
                    window.alert('正しい携帯番号（電話番号）を入力してください');
                } else {

                    const database = firebase.firestore();

                    const profile = await liff.getProfile();
                    await database
                        .collection("user")
                        .doc(profile.userId)
                        .set({ userId: profile.userId, name: name, tel: number, reservationDate: date.replaceAll("/", "-"), reservationTime: date.replaceAll("/", "-") + " " + time });

                    let text = "お申し込み";

                    // トーク画面にメッセージを送信します。
                    liff.sendMessages([{
                        'type': 'text',
                        'text': text
                    }]).then(function () {
                        liff.closeWindow()
                    }).catch(function (error) {
                        window.alert('エラー送信: ' + error);
                    });
                }
            });
            document.getElementsByName("date")[0].addEventListener('change', async function (e) {
                const { value } = e.target;
                const [year, month, date] = value.split("/");
                const bookingData = await database
                    .collection("booking")
                    .doc(year + "-" + month)
                    .get();
                const available = [];
                if (bookingData.exists) {
                    const day = parseInt(date, 10);
                    const currentData = bookingData.data().max[day - 1];
                    const today = new Date(new Date().getTime());
                    if (day === today.getDate()) {
                        // 30分後に受付開始
                        const open = today.setMinutes(
                            Math.round(today.getMinutes() / 15) * 15 + 30
                        );
                        const h = ("00" + new Date(open).getHours()).slice(-2);
                        const M = ("00" + new Date(open).getMinutes()).slice(-2);
                        // 11:30-14:15
                        [...Array(12)].map((_, i) => {
                            const date = new Date();
                            date.setHours(11);
                            date.setMinutes(30);
                            const _date = new Date(date).setMinutes(
                                new Date(date).getMinutes() + i * 15
                            );
                            const hh = ("00" + new Date(_date).getHours()).slice(-2);
                            const MM = ("00" + new Date(_date).getMinutes()).slice(-2);
                            if (
                                h + ":" + M <= hh + ":" + MM &&
                                currentData[hh + "時台"][1] > 0
                            ) {
                                available.push(hh + ":" + MM);
                            }
                        });
                        // 17:30-21:30
                        [...Array(17)].map((_, i) => {
                            const date = new Date();
                            date.setHours(17);
                            date.setMinutes(30);
                            const _date = new Date(date).setMinutes(
                                new Date(date).getMinutes() + i * 15
                            );
                            const hh = ("00" + new Date(_date).getHours()).slice(-2);
                            const MM = ("00" + new Date(_date).getMinutes()).slice(-2);
                            if (
                                h + ":" + M <= hh + ":" + MM &&
                                currentData[hh + "時台"][1] > 0
                            ) {
                                available.push(hh + ":" + MM);
                            }
                        });
                    } else {
                        // 11:30-14:15
                        [...Array(12)].map((_, i) => {
                            const date = new Date();
                            date.setHours(11);
                            date.setMinutes(30);
                            const _date = new Date(date).setMinutes(
                                new Date(date).getMinutes() + i * 15
                            );
                            const hh = ("00" + new Date(_date).getHours()).slice(-2);
                            const MM = ("00" + new Date(_date).getMinutes()).slice(-2);
                            if (currentData[hh + "時台"][1] > 0) {
                                available.push(hh + ":" + MM);
                            }
                        });
                        // 17:30-21:30
                        [...Array(17)].map((_, i) => {
                            const date = new Date();
                            date.setHours(17);
                            date.setMinutes(30);
                            const _date = new Date(date).setMinutes(
                                new Date(date).getMinutes() + i * 15
                            );
                            const hh = ("00" + new Date(_date).getHours()).slice(-2);
                            const MM = ("00" + new Date(_date).getMinutes()).slice(-2);
                            if (currentData[hh + "時台"][1] > 0) {
                                available.push(hh + ":" + MM);
                            }
                        });
                    }
                }
                // 要素を追加
                const timeElem = document.getElementsByName("time")[0];
                while (timeElem.firstChild) {
                    timeElem.removeChild(timeElem.firstChild)
                }
                const timeOption = document.createElement("option");
                timeOption.text = "時間を選択";
                timeElem.appendChild(timeOption);
                for (let i = 0; i < available.length; i++) {
                    const timeOption = document.createElement("option");
                    timeOption.text = available[i];
                    timeOption.value = available[i];
                    timeElem.appendChild(timeOption);
                }
            });
        };

        function initializeLiff(myLiffId) {
            // LIFFアプリを初期化
            liff.init(
                {
                    liffId: myLiffId
                })
                .then(() => {
                    // ユーザーがログインしているかどうかを取得します。
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    }
                    // ユーザーのプロフィールを取得します。
                    liff.getProfile().then(function (profile) {
                        $("input[name='name']").val(profile.displayName);
                    })
                        .catch(function (error) {
                            window.alert('プロファイル取得のエラー: ' + error);
                        });
                })
                .catch((error) => {
                    window.alert('初期化のエラー: ' + error);
                });
        }

        async function addDate() {
            // 予約データを取得
            const min = zeroPadding(new Date().toLocaleDateString());
            let [year, month, date] = min.split("-");
            const bookingData = await database
                .collection("booking")
                .doc(year + "-" + month)
                .get();
            const available = [];
            if (bookingData.exists) {
                const arr = bookingData.data().stop;
                const _date = parseInt(date, 10);
                arr.slice(_date - 1, _date + 6).forEach((flag, i) => !flag && available.push(year + "/" + month + "/" + (_date + i)));
            }
            if (available.length < 6) {
                if (month < 12) {
                    month = parseInt(month) + 1;
                } else {
                    year = parseInt(year) + 1;
                    month = 1;
                }
                const bookingData = await database
                    .collection("booking")
                    .doc(year + "-" + ("00" + month).slice(-2))
                    .get();

                if (bookingData.exists) {
                    const arr = bookingData.data().stop;
                    let _date = 1;
                    while (available.length < 6) {
                        const flag = arr.shift();
                        if (!flag) available.push(year + "/" + month + "/" + _date);
                        _date += 1;
                    }
                }
            }
            // 要素を追加
            const dateElem = document.getElementsByName("date")[0];
            for (let i = 0; i < available.length; i++) {
                const dateOption = document.createElement("option");
                dateOption.text = available[i];
                dateOption.value = available[i];
                dateElem.appendChild(dateOption)
            }
        }
        
        function replaceAll(str, beforeStr, afterStr) {
            var reg = new RegExp(beforeStr, "g");
            return str.replace(reg, afterStr);
        }

        function zeroPadding(date) {
            var [year, month, day] = date.split("/");
            return year + "-" + ("0" + month).slice(-2) + "-" + ("0" + day).slice(-2);
        }
    </script>
</head>

<body>
    <!-- 申し込みに必要な情報を入力 -->
    <div class="container">
        <form>
            <div class="form-group">
                <label for="name">お名前</label>
                <input id="name" type="text" name="name" class="form-control" placeholder="名前を入力して下さい"
                    required="required" />
            </div>
            <div class="form-group">
                <label for="number">電話番号</label>
                <input id="number" type="tel" class="form-control" name="number" required="required" />
            </div>
            <div class="form-group">
                <label>受け取り日時</label>
                <div class="f-container">
                    <select name="date" required="required" class="styled-select">
                        <option value="">日付を選択</option>
                    </select>
                    <select name="time" required="required" class="styled-select">
                        <option value="">時間を選択</option>
                    </select>
                </div>
            </div>
            <button id="send" class="btn btn-primary btn-lg btn-block" type="button">申込</button>
        </form>
    </div>
</body>